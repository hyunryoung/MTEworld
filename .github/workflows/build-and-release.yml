name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # v0.0.1, v1.0.0 ë“±ì˜ íƒœê·¸ì—ì„œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller customtkinter selenium pandas openpyxl webdriver-manager Pillow requests psutil openai
        
    - name: ë²„ì „ ì •ë³´ ì¶”ì¶œ
      id: version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "ë²„ì „: $version"
        
    - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
      run: |
        pyinstaller --onedir --windowed --name CafePostingAutomation --add-data "license_manager_modern.py;." --add-data "ë¼ì´ì„ ìŠ¤_ì‚¬ìš©ë²•.txt;." --hidden-import customtkinter --hidden-import selenium --hidden-import pandas --hidden-import openpyxl --hidden-import webdriver-manager --hidden-import PIL --hidden-import requests --hidden-import psutil --hidden-import openai --exclude-module matplotlib --exclude-module scipy --clean --noconfirm "ì¹´í˜ ìˆ˜ì •ë°œí–‰.py"
        
    - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        ls -la dist/
        ls -la dist/CafePostingAutomation/
        
    - name: ë°°í¬ìš© ZIP ìƒì„±
      run: |
        cd dist
        Compress-Archive -Path CafePostingAutomation -DestinationPath "CafePostingAutomation_v${{ steps.version.outputs.VERSION }}.zip"
        ls -la *.zip
        
    - name: Release ìƒì„±
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/CafePostingAutomation_v${{ steps.version.outputs.VERSION }}.zip
        generate_release_notes: true
        draft: false
        prerelease: false
        name: "ì¹´í˜ ìˆ˜ì •ë°œí–‰ í”„ë¡œê·¸ë¨ v${{ steps.version.outputs.VERSION }}"
        body: |
          ## ğŸš€ ì¹´í˜ ìˆ˜ì •ë°œí–‰ í”„ë¡œê·¸ë¨ v${{ steps.version.outputs.VERSION }}
          
          ### ğŸ“¦ ë‹¤ìš´ë¡œë“œ
          - `CafePostingAutomation_v${{ steps.version.outputs.VERSION }}.zip` íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”
          - ZIP íŒŒì¼ì„ ì••ì¶• í•´ì œ í›„ `CafePostingAutomation.exe` ì‹¤í–‰
          
          ### ğŸ” ë¼ì´ì„ ìŠ¤
          - í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì‹œ ë¼ì´ì„ ìŠ¤ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤
          - ë¨¸ì‹  IDë¥¼ ê´€ë¦¬ìì—ê²Œ ì „ë‹¬í•˜ì—¬ ë¼ì´ì„ ìŠ¤ë¥¼ ë°›ìœ¼ì„¸ìš”
          
          ### ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥
          - ë„¤ì´ë²„ ì¹´í˜ ë‹µê¸€/ëŒ“ê¸€ ìë™ ì‘ì„±
          - ë©¤ë²„ê³µê°œ â†’ ì „ì²´ê³µê°œ ìë™ ë³€ê²½
          - ì‘ì—… ì™„ë£Œ í›„ ëŒ“ê¸€ ì°¨ë‹¨
          - ë¼ì´ì„ ìŠ¤ ì¸ì¦ ì‹œìŠ¤í…œ
          - ìë™ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥
          
          ### âš ï¸ ì£¼ì˜ì‚¬í•­
          - êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”
          - ë„¤ì´ë²„ ì´ìš©ì•½ê´€ì„ ì¤€ìˆ˜í•´ì£¼ì„¸ìš”
          - ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
