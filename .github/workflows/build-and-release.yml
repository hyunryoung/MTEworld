name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # v0.0.1, v1.0.0 등의 태그에서 실행
  workflow_dispatch:  # 수동 실행 가능

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 체크아웃
      uses: actions/checkout@v3
      
    - name: Python 설정
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 의존성 설치
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller customtkinter selenium pandas openpyxl webdriver-manager Pillow requests psutil openai
        
    - name: 버전 정보 추출
      id: version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "버전: $version"
        
    - name: 애플리케이션 빌드
      run: |
        pyinstaller --onedir --windowed --name CafePostingAutomation --add-data "license_manager_modern.py;." --add-data "라이선스_사용법.txt;." --hidden-import customtkinter --hidden-import selenium --hidden-import pandas --hidden-import openpyxl --hidden-import webdriver-manager --hidden-import PIL --hidden-import requests --hidden-import psutil --hidden-import openai --exclude-module matplotlib --exclude-module scipy --clean --noconfirm "카페 수정발행.py"
        
    - name: 빌드 결과 확인
      run: |
        ls -la dist/
        ls -la dist/CafePostingAutomation/
        
    - name: 배포용 ZIP 생성
      run: |
        cd dist
        Compress-Archive -Path CafePostingAutomation -DestinationPath "CafePostingAutomation_v${{ steps.version.outputs.VERSION }}.zip"
        ls -la *.zip
        
    - name: Release 생성
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/CafePostingAutomation_v${{ steps.version.outputs.VERSION }}.zip
        generate_release_notes: true
        draft: false
        prerelease: false
        name: "카페 수정발행 프로그램 v${{ steps.version.outputs.VERSION }}"
        body: |
          ## 🚀 카페 수정발행 프로그램 v${{ steps.version.outputs.VERSION }}
          
          ### 📦 다운로드
          - `CafePostingAutomation_v${{ steps.version.outputs.VERSION }}.zip` 파일을 다운로드하세요
          - ZIP 파일을 압축 해제 후 `CafePostingAutomation.exe` 실행
          
          ### 🔐 라이선스
          - 프로그램 실행 시 라이선스 인증이 필요합니다
          - 머신 ID를 관리자에게 전달하여 라이선스를 받으세요
          
          ### 📋 주요 기능
          - 네이버 카페 답글/댓글 자동 작성
          - 멤버공개 → 전체공개 자동 변경
          - 작업 완료 후 댓글 차단
          - 라이선스 인증 시스템
          - 자동 업데이트 기능
          
          ### ⚠️ 주의사항
          - 교육 목적으로만 사용하세요
          - 네이버 이용약관을 준수해주세요
          - 사용으로 인한 책임은 사용자에게 있습니다
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
